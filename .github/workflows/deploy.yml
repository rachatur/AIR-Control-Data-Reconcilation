name: Deploy AIR Dashboard

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        
      - name: Generate index.html (Auto File List)
        run: |
          echo "<!DOCTYPE html>" > index.html
          echo "<html><head><meta charset='UTF-8'><title>Repository Index</title></head><body>" >> index.html
          echo "<h1>Repository File Index</h1>" >> index.html
          echo "<ul>" >> index.html

          # List all files except .git, .github, node_modules, and index.html itself
          find . -type f \
            ! -path "./.git/*" \
            ! -path "./.github/*" \
            ! -path "./node_modules/*" \
            ! -name "index.html" \
          | while read FILE; do
              FILE="${FILE#./}"
              echo "<li><a href=\"$FILE\">$FILE</a></li>" >> index.html
            done

          echo "</ul>" >> index.html
          echo "</body></html>" >> index.html

      - name: Commit index.html (Prevent Infinite Loop)
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Only commit if index.html changed
          if ! git diff --quiet index.html; then
            git add index.html
            git commit -m "Auto-update index.html (file index)"
            git push
          else
            echo "No index.html changes â€” skipping commit."
          fi
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ~/AIR/AIR-Control-Data-Reconcilation

            echo "------------------------------------"
            echo "Fetching latest code from GitHub..."
            echo "------------------------------------"
            git fetch --all
            git reset --hard origin/main

            echo "------------------------------------"
            echo "Building Docker image (no cache)..."
            echo "------------------------------------"
            docker build --no-cache -t air-dashboard .

            echo "------------------------------------"
            echo "Stopping old container..."
            echo "------------------------------------"
            docker rm -f air-dashboard-container || true

            echo "------------------------------------"
            echo "Starting new container on host network..."
            echo "------------------------------------"
            docker run -d --name air-dashboard-container --network host air-dashboard

            echo "------------------------------------"
            echo "Deployment complete!"
            echo "------------------------------------"
